<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.minglemingle.chat2mingle.message.mapper.MessageMapper">
    <resultMap id="messageResultMap" type="Message">
        <id property="messageId" column="message_id"/>
        <result property="nickname" column="nickname"/>
        <result property="channel" column="channel"/>
        <result property="content" column="content"/>
        <result property="messageType" column="message_type"/>
        <result property="sentAt" column="sent_at"/>
    </resultMap>

    <select id="selectOneMessage" parameterType="Message" resultMap="messageResultMap">
        SELECT message_id,
               nickname,
               channel,
               content,
               message_type,
               sent_at
        FROM message
        WHERE message_id = #{messageId}
    </select>

    <select id="selectMessageWithOffset" parameterType="Integer" resultMap="messageResultMap">
        SELECT message_id,
               nickname,
               channel,
               content,
               message_type,
               sent_at
        FROM message
        ORDER BY message_id
        OFFSET #{offset} ROWS FETCH NEXT 5 ROWS ONLY
    </select>

    <select id="selectMessageListAfterMessageId" parameterType="Message" resultMap="messageResultMap">
        <![CDATA[
        SELECT message_id,
                nickname,
                channel,
                content,
                message_type,
                sent_at
        FROM message
        WHERE message_id < #{messageId}
        ORDER BY message_id DESC
        FETCH FIRST 5 ROWS ONLY
        ]]>
    </select>


    <insert id="insertOneMessage" parameterType="Message">
        INSERT INTO COMMENTS (nickname, channel, content, message_type, sent_at)
        VALUES (#{nickname}, #{channel}, #{content}, #{messageType}, #{sentAt})

        <selectKey keyProperty="messageId" resultType="Integer" order="AFTER">
            SELECT MESSAGE_SEQ.CURRVAL FROM DUAL
        </selectKey>
    </insert>

    <delete id="deleteOneMessage" parameterType="Message">
        DELETE FROM message WHERE message_id = #{messageId};
    </delete>
</mapper>